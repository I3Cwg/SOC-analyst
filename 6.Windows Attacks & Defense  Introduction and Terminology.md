Below is a detailed **explanation** of the **Lab Environment** described in the lesson you're studying:

# ğŸ§ª **Lab Environment**

### ğŸ”¹ Purpose:

You are provided with a **virtual practice environment** (playground) where you can:

- **Experiment with the attacks** described in the material.
- Follow **step-by-step walkthroughs** to understand how specific vulnerabilities are exploited.

âš ï¸ **Important Notes**:

- These walkthroughs are meant to **demonstrate the vulnerabilities**, **not to explain them in-depth**.
- If you want more technical details about each attack, **other modules on the platform** provide comprehensive explanations.

## ğŸ–¥ï¸ **Machines Used to Perform Attacks**

You will **simulate a scenario** where an attacker has already gained **remote code execution** on a Windows 10 machine:

| Component              | Description                                                                                                           |
| ---------------------- | --------------------------------------------------------------------------------------------------------------------- |
| **WS001 (Windows 10)** | The compromised machine. The current user is **Bob**, a regular Active Directory user with **no special privileges**. |
| **Kali Linux**         | The attacker's machine, used to launch various attacks.                                                               |

## ğŸ§± **Network Topology (Machines and IPs)**

| Machine        | IP Address             | Role                                                                              |
| -------------- | ---------------------- | --------------------------------------------------------------------------------- |
| **DC1**        | `172.16.18.3`          | Domain Controller 1 (primary Active Directory controller)                         |
| **DC2**        | `172.16.18.4`          | Domain Controller 2 (secondary or load-balanced)                                  |
| **Server01**   | `172.16.18.10`         | Service server in the network (could host data, file shares, etc.)                |
| **PKI**        | `172.16.18.15`         | Public Key Infrastructure â€“ certificate server (used in attacks like AD CS abuse) |
| **WS001**      | `172.16.18.25` or DHCP | Compromised user machine (Bob)                                                    |
| **Kali Linux** | `172.16.18.20` or DHCP | Attackerâ€™s machine                                                                |

ğŸ‘‰ Depending on the section, the IPs may be **static** or assigned via **DHCP**.

## âœ… Scenario Summary:

- The attacker has already **gained access** to a Windows machine inside the internal network (WS001 â€“ user Bob).
- The goal is to perform **lateral movement**, **privilege escalation**, and more.
- You will use **Kali Linux** and **WS001** to practice these techniques in a simulated enterprise environment with Active Directory.

---
# Introduction and Terminology
## **What is Active Directory (AD)?** ğŸ“‚

**Active Directory (AD)** is a **directory service** developed by Microsoft, officially released in 2000 with **Windows Server 2000**. Since then, Microsoft has continuously improved AD with each new server OS release. Based on the **X.500** and **LDAP** protocols, AD is a **distributed**, **hierarchical structure** that allows centralized management of an organization's resources.

#### **AD Manages** ğŸ§‘â€ğŸ’»:

- **Users** ğŸ§‘â€ğŸ’¼  
- **Computers** ğŸ–¥ï¸  
- **Groups** ğŸ‘¥  
- **Network Devices** ğŸŒ  
- **File Shares** ğŸ“  
- **Group Policies** ğŸ“œ  
- **Trusts** ğŸ”—

It provides essential functionalities such as:

- **Authentication** âœ…
- **Authorization** ğŸ”‘
- **Accounting** ğŸ“Š

AD ensures that administrators can manage permissions and control access to network resources across the organization.

### **Why is Active Directory Important?** ğŸ”‘

AD is widely used in enterprise environments, making it the **most common Identity and Access Management (IAM)** solution globally. **Most enterprise applications integrate seamlessly with AD**, making it a critical service for organizations.

#### **Impact of AD Compromise** âš ï¸

A breach in AD could mean the compromise of **all systems, data, and applications** in the organization, violating the **CIA** (Confidentiality, Integrity, and Availability) triad. This makes AD one of the most crucial components in any enterprise network. 

#### **Example of a Threat - Ransomware** ğŸ¦ 

- Attackers can exploit vulnerabilities in AD to deploy **ransomware**, which encrypts the organization's data and demands a ransom for decryption.
- Compromising AD is more dangerous than a single system breach because it affects the entire network.

### **AD Vulnerabilities and the Growing Threat** ğŸ”“

- **Microsoft** has disclosed **over 9,000 vulnerabilities** in AD since 1999, with **3,000** discovered between 2020 and 2022.
- These vulnerabilities indicate **growing research** and attacks targeting AD, making it a prime target for cybercriminals.

### **How to Secure Active Directory?** ğŸ›¡ï¸

#### **Patch Management** âš™ï¸

- **Patch management** is essential to keep AD secure. Proper patching prevents many exploits, but organizations still struggle with this.

#### **Other Security Measures** ğŸ› ï¸

- **Defense in Depth** ğŸ›¡ï¸: Implement multiple layers of security controls to protect the network.
- **Network Segmentation** ğŸ”Œ: Isolate critical systems to minimize damage from a potential breach.

### **Further Learning** ğŸ“š

If you're new to AD, consider reviewing these resources:

- **Intro to Active Directory**: Learn the basic structure and functions of AD.
- **Active Directory â€“ Enumeration and Attacks**: Deepen your knowledge of common attacks and defenses.


## ğŸ” **Active Directory (AD) Refresher**

### ğŸŒ **1. Domain**
- A domain is a group of users, computers, and devices sharing the same **AD database**.
- **Example**: `test.local`  
ğŸ§‘â€ğŸ’» + ğŸ’» + ğŸ“‚ = One Domain

### ğŸŒ³ **2. Tree**
- One or more **domains grouped in a hierarchical structure**.
- Share the same **namespace**.
- **Example**:  
  - `test.local`  
  - `staging.test.local`  
  - `preprod.test.local`  
ğŸ“ Tree = Domain + Subdomains

### ğŸŒ² **3. Forest**
- A collection of multiple **trees**.
- The **topmost structure** in AD.  
ğŸŒ Forest = All Domains + All Trees

### ğŸ—‚ **4. Organizational Unit (OU)**
- Containers inside a domain to organize users, computers, and groups.
- Helps with delegation and structure.  
ğŸ—ƒ OU = Logical folders in AD

### ğŸ¤ **5. Trust**
- A relationship that **allows access to resources** across domains.
ğŸ”— Domain A ğŸ” Domain B


### ğŸ–¥ **6. Domain Controller (DC)**
- The **boss server** that manages the domain.
- Handles:
  - **Authentication** âœ…  
  - **Authorization** ğŸ”

### ğŸ’¾ **7. Active Directory Data Store**
- Where all the AD data lives.
- Most important file: `NTDS.DIT`
ğŸ“ Path: `%SystemRoot%\NTDS`

### ğŸ‘¤ **8. Regular AD User**
- Can still **enumerate** lots of AD data:
  - Domain Users ğŸ‘¥  
  - Domain Computers ğŸ’»  
  - Groups ğŸ“š  
  - GPOs âš™  
  - Trusts ğŸ”’

### ğŸ“¡ **9. LDAP (Lightweight Directory Access Protocol)**
- Used by systems to talk to AD.
- Runs on ports **389** (plaintext) and **636** (SSL).
ğŸ” LDAP = Speak ADâ€™s language

### ğŸ›¡ **10. Authentication in Windows**
- Methods include:
  - Username & Password ğŸ”‘  
  - NetNTLMv1 / v2  
  - Kerberos ğŸ«  
  - Certificates ğŸ“œ

### ğŸ« **11. Kerberos & KDC**
- **KDC (Key Distribution Center)** lives on the DC.
- Issues **tickets**:
  - **TGT (Ticket Granting Ticket)**  
  - **TGS (Ticket Granting Service)**  
- Uses **KRBTGT account** to generate encryption keys.

### ğŸ‘‘ **12. Privileged Groups**
- **Domain Admins** & **Administrators**: ğŸ¦¸â€â™‚ï¸ full access
- **Enterprise Admins**: top-level across all domains
- **Account Operators**: can reset passwords (âš ï¸ can be misused!)

### ğŸ’» **13. Logon Types**
- Show how users log in:
  - Type 2: Interactive ğŸ§‘â€ğŸ’»  
  - Type 3: Network ğŸŒ  
  - Type 10: Remote via RDP ğŸ–¥
âš ï¸ Only Type 3 doesnâ€™t leave password traces


### ğŸ§° **14. RSAT Tools (GUI for Admins)**
- **AD Users & Computers** ğŸ§‘â€ğŸ’¼ğŸ‘©â€ğŸ’¼  
- **Group Policy Management** ğŸ›   
These tools turn **LDAP queries into mouse clicks!**

### ğŸŒ **15. Important Windows Ports**
| Port | Service                |
|------|------------------------|
| 53   | DNS                    |
| 88   | Kerberos               |
| 135  | RPC / WMI              |
| 137-139 / 445 | SMB          |
| 389 / 636 | LDAP              | 
| 3389 | RDP                    | 
| 5985 / 5986 | WinRM (PowerShell) |



## ğŸŒ **Real-World View of Active Directory (AD)**

### **1. System Classification** ğŸ—‚ï¸  
Every organization classifies systems based on their **importance to business operations**.  
Examples:  
- **ERP** ğŸ“Š  
- **CRM** ğŸ¤  
- **Backups** ğŸ’¾  

ğŸ” In Active Directory, **additional roles/services** (like DNS, PKI, SCCM) must also be classified.  
Why? Because if these services are **compromised**, they can become **privilege escalation paths** into the **core of the AD forest**.

### **2. Privilege Escalation Paths** â›“ï¸  
- AD is complex and **feature-heavy**  
- Attackers who gain admin access to services like DNS or Configuration Manager can often **indirectly escalate to Domain Admin**

ğŸ›¡ï¸ These systems must be protected as carefully as **Domain Controllers**, as they can act as backdoors into the forest.

### **3. ADâ€™s Built-in Weaknesses** âš ï¸  
There are **three main categories** of weaknesses that increase the attack surface:

#### ğŸ§© a) Complexity: **Nested Groups**
- Users can be members of groups â¡ï¸ inside other groups â¡ï¸ and so on...  
- This makes it hard to track who has what permissions  
- In some environments, even a regular user can **indirectly be a Domain Admin**

ğŸ§  Tip: Always check **group membership chains** when auditing access

#### ğŸ—ï¸ b) Design Flaws: **GPO + SYSVOL + SMB**
- **GPOs** are stored in a shared folder: `\\DOMAIN\SYSVOL`
- Every domain-joined machine pulls policies from SYSVOL using **SMB (port 445)**
- If an attacker has **valid credentials**, they can:
  - Remotely access SYSVOL  
  - **Execute commands on Domain Controllers** over SMB

ğŸš« This violates **Zero Trust** principles and creates remote code execution risk.

#### ğŸ“» c) Legacy Protocols: **NetBIOS + LLMNR**
- Enabled by default in Windows (for backward compatibility)
- These protocols **broadcast user credentials** over the network
- Even if DNS is working, they remain active  
- Attackers can use tools to capture these and **crack password hashes**

ğŸ’¥ One packet sniffing session = potential **domain compromise**

### âœ… Key Takeaways:
- ğŸ“Œ **Classify** services based on impact and escalation potential
- ğŸ“Œ Treat certain systems like **DNS/PKI** as high-value assets
- ğŸ“Œ Watch out for **nested group escalation paths**
- ğŸ“Œ Disable **legacy protocols** (NetBIOS, LLMNR)
- ğŸ“Œ Monitor and restrict access to **SYSVOL and SMB**

---


## ğŸ§± **1. DC1 â€“ Primary Domain Controller**

### ğŸ”§ Installation

- **Operating System**: Windows Server 2019 or 2022
- **Hostname**: `DC1`
- **Static IP**: `172.16.18.3`
- **Subnet Mask**: `255.255.255.0`
- **Gateway**: `172.16.18.1` (can be a dummy if no router is present)
- **DNS**: `127.0.0.1`

> How to configure IP:

1. Open `Control Panel` â†’ `Network and Sharing Center` â†’ `Change adapter settings`
2. Right-click the network card â†’ Properties â†’ Internet Protocol Version 4 (TCP/IPv4)
3. Set the IP, Subnet, Gateway, DNS as above

### ğŸ—ï¸ Install AD Domain Services

1. Open **Server Manager**
2. Click **Manage** â†’ **Add Roles and Features**
3. Select:
   - Role-based installation
   - Select DC1 machine
   - Check **Active Directory Domain Services**
4. Click Next until done â†’ Install

### ğŸš€ Promote to Domain Controller

1. After installation, Server Manager will show a warning: "Promote this server to a domain controller"
2. Select **Add a new forest**
   - Domain name: `lab.local`
3. Set a DSRM password
4. Click Next â†’ Next â†’ Install
5. The machine will automatically reboot

### âœ… Post-reboot checks:

- Open `cmd`, run:

```bash
ipconfig /all
nslookup dc1.lab.local
```

- Open `Active Directory Users and Computers` â†’ confirm `lab.local` exists
- Create a new OU, e.g., `LabUsers`


## ğŸ–¥ï¸ **2. WS001 â€“ Windows 10 (Bob's Workstation)**

### ğŸ”§ Basic Configuration:

- **Hostname**: `WS001`
- **IP**: DHCP (or static: `172.16.18.25`, DNS: `172.16.18.3`)

### ğŸ”Œ Join the `lab.local` domain:

1. Right-click `This PC` â†’ Properties â†’ Advanced system settings â†’ Computer Name â†’ Change
2. Choose Domain: type `lab.local`
3. Enter domain credentials

> The machine will require a restart after successfully joining the domain

### ğŸ‘¤ Create user "Bob" on DC1:

1. On DC1 â†’ open `Active Directory Users and Computers`
2. Right-click `LabUsers` OU â†’ New â†’ User
3. Create:
   - **Username**: `bob`

### âœ… Verification:

- On WS001, log out of the local account
- Select â€œOther Userâ€ â†’ log in with: `lab\bob`

## ğŸ **3. Kali Linux (Attack Machine)**

### ğŸ› ï¸ Setup:

- IP: DHCP (or static: `172.16.18.20`, DNS: `172.16.18.3`)
- Hostname: `kali`
- Install the following tools:

```bash
sudo apt update && sudo apt install bloodhound bloodhound-python impacket-scripts evil-winrm certipy
```
### âœ… Verification:

- Ping DC1:

```bash
ping dc1.lab.local
```

- DNS query:

```bash
nslookup dc1.lab.local 172.16.18.3
```
netsh interface ip set address name="Ethernet1" static 172.16.18.25 255.255.255.0
netsh interface ip set dns name="Ethernet1" static 172.16.18.3

## 






